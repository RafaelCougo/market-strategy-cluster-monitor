# -*- coding: utf-8 -*-
"""üìä Market Cluster Dashboard - Google Colab.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1d7yGayUroOBjnvqcUGFzu9RqgWnbv8zx

C√©lula 1: Instalar Depend√™ncias
"""

# Instalar bibliotecas necess√°rias
!pip install -q yfinance pandas plotly

print("‚úì Depend√™ncias instaladas com sucesso!")

"""üîß C√©lula 2: Importar Bibliotecas e Configurar Clusters"""

import yfinance as yf
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import json
from datetime import datetime
import warnings
warnings.filterwarnings('ignore')

# ============================================================================
# CONFIGURA√á√ÉO DOS CLUSTERS
# ============================================================================

CLUSTERS = {
    "1_ia_infraestrutura": {
        "nome": "Infraestrutura de IA & Super-Ciclo de Mem√≥ria",
        "tese": "A acelera√ß√£o da IA exige expans√£o f√≠sica massiva de hardware e data centers.",
        "driver_principal": "Outlook de IA e backlog de pedidos bilion√°rios",
        "proxy_narrativa": "Crescimento de capex em data centers e volume de pedidos de chips",
        "ativos": {
            "AMD": {"papel": "Alternativa de GPU", "proxy": "Market share em infer√™ncia"},
            "MU": {"papel": "Mem√≥ria HBM", "proxy": "Super-ciclo de mem√≥ria"},
            "VRT": {"papel": "Refrigera√ß√£o", "proxy": "Infraestrutura de data centers"},
            "APLD": {"papel": "Hosting de Data Centers", "proxy": "Opera√ß√£o direta de infraestrutura"},
        },
    },

    "2_juros_desreg": {
        "nome": "Proxies de Juros & Desregulamenta√ß√£o US",
        "tese": "Normaliza√ß√£o da pol√≠tica monet√°ria beneficia o setor financeiro.",
        "driver_principal": "Ciclo de pol√≠tica monet√°ria e for√ßa do mercado de trabalho",
        "proxy_narrativa": "Taxa de desemprego, decis√µes do Fed, volume de refinanciamentos",
        "ativos": {
            "ADP": {"papel": "Proxy de Emprego", "proxy": "For√ßa do mercado de trabalho"},
            "JPM": {"papel": "L√≠der Banc√°rio", "proxy": "Consolida√ß√£o e desregulamenta√ß√£o"},
            "SOFI": {"papel": "Fintech Escal√°vel", "proxy": "Expans√£o de margem"},
            "BLK": {"papel": "Fluxo de Capital", "proxy": "AUM em ciclo risco-on"},
        },
    },

    "3_defesa_moats": {
        "nome": "Defesa de Portf√≥lio & Moats Inabal√°veis",
        "tese": "Empresas com barreiras de entrada inabal√°veis oferecem prote√ß√£o.",
        "driver_principal": "Robustez vs. Macro e barreiras de entrada",
        "proxy_narrativa": "Pricing power, brand strength, consist√™ncia de dividendos",
        "ativos": {
            "BRK-B": {"papel": "Robustez Extrema", "proxy": "Caixa e diversifica√ß√£o"},
            "KO": {"papel": "Pricing Power", "proxy": "For√ßa da marca global"},
            "PG": {"papel": "Consumo Essencial", "proxy": "Resili√™ncia em recess√µes"},
            "AMZN": {"papel": "Moat de Rede", "proxy": "Dom√≠nio log√≠stico e AWS"},
        },
    },

    "4_tarifas_commodities": {
        "nome": "Arbitragem de Tarifas & Commodities (Brasil)",
        "tese": "Tarifas US criam oportunidades de arbitragem e protegem empresas locais.",
        "driver_principal": "Tens√µes comerciais globais e efici√™ncia local",
        "proxy_narrativa": "Volume de tarifas impostas, demanda chinesa, fluxo estrangeiro",
        "ativos": {
            "GGBR4.SA": {"papel": "Siderurgia Local", "proxy": "Prote√ß√£o de mercado"},
            "VALE3.SA": {"papel": "Custo de Produ√ß√£o", "proxy": "Qualidade e efici√™ncia"},
            "WEGE3.SA": {"papel": "Efici√™ncia Global", "proxy": "Exposi√ß√£o cambial"},
            "EWZ": {"papel": "Fluxo Estrangeiro", "proxy": "Apetite de risco em EM"},
        },
    },

    "5_quantum_seguranca": {
        "nome": "Computa√ß√£o Qu√¢ntica & Ciberseguran√ßa P√≥s-Qu√¢ntica",
        "tese": "Computa√ß√£o qu√¢ntica atingiu maturidade comercial.",
        "driver_principal": "Maturidade comercial de qubits e compliance de seguran√ßa",
        "proxy_narrativa": "Roadmap de qubits, parcerias industriais, contratos de compliance",
        "ativos": {
            "IONQ": {"papel": "Hardware Qu√¢ntico", "proxy": "Roadmap de 256 qubits"},
            "QBTS": {"papel": "Computa√ß√£o de Recozimento", "proxy": "Otimiza√ß√£o comercial"},
            "RGTI": {"papel": "Sistemas Full-Stack", "proxy": "Integra√ß√£o hardware-software"},
            "CRWD": {"papel": "Defesa Digital PQC", "proxy": "Adapta√ß√£o de protocolos"},
        },
    },

    "6_defesa_autonoma": {
        "nome": "Defesa Aut√¥noma & Sistemas de Drones",
        "tese": "Doutrina militar mudou para sistemas aut√¥nomos.",
        "driver_principal": "Mudan√ßa doutrin√°ria militar e efici√™ncia de custos",
        "proxy_narrativa": "Contratos militares, volume de conflitos, ado√ß√£o de drones",
        "ativos": {
            "AVAV": {"papel": "Drones T√°ticos", "proxy": "Lideran√ßa em sistemas n√£o tripulados"},
            "KTOS": {"papel": "Alvos e Drones", "proxy": "Drones de baixo custo"},
            "EH": {"papel": "Mobilidade A√©rea", "proxy": "Expans√£o de log√≠stica aut√¥noma"},
            "PLTR": {"papel": "Software de Combate", "proxy": "Coordena√ß√£o de sistemas aut√¥nomos"},
        },
    },

    "7_cripto_infraestrutura": {
        "nome": "Cripto-Infraestrutura & Alavancagem Operacional",
        "tese": "Melhor trade em cripto √© via alavancagem operacional.",
        "driver_principal": "Alavancagem operacional e converg√™ncia com IA",
        "proxy_narrativa": "Pre√ßo do BTC, volume de minera√ß√£o, contratos de energia",
        "ativos": {
            "MSTR": {"papel": "Proxy de Bitcoin", "proxy": "Alavancagem financeira extrema"},
            "COIN": {"papel": "Infraestrutura de Troca", "proxy": "Volume de negocia√ß√£o"},
            "MARA": {"papel": "Minera√ß√£o Verticalizada", "proxy": "Efici√™ncia operacional"},
            "RIOT": {"papel": "Escala de Minera√ß√£o", "proxy": "Expans√£o de hash rate"},
        },
    },
}

print("‚úì Clusters configurados!")

"""üìä C√©lula 3: Fun√ß√£o para Buscar Dados de Mercado"""

def fetch_market_data(verbose=True):
    """Busca dados de mercado para todos os ativos"""
    all_data = {}

    for cluster_id, cluster_info in CLUSTERS.items():
        if verbose:
            print(f"üìä Buscando {cluster_info['nome']}...")

        cluster_data = {
            "cluster_id": cluster_id,
            "nome": cluster_info["nome"],
            "tese": cluster_info["tese"],
            "driver_principal": cluster_info["driver_principal"],
            "proxy_narrativa": cluster_info["proxy_narrativa"],
            "ativos": {},
            "timestamp": datetime.now().isoformat(),
        }

        for ticker, ativo_info in cluster_info["ativos"].items():
            try:
                dados = yf.Ticker(ticker)
                hist = dados.history(period="1d")

                if not hist.empty:
                    preco_atual = hist["Close"].iloc[-1]
                    volume = hist["Volume"].iloc[-1]

                    hist_30d = dados.history(period="30d")
                    preco_30d_atras = hist_30d["Close"].iloc[0] if len(hist_30d) > 0 else preco_atual
                    variacao_30d = ((preco_atual - preco_30d_atras) / preco_30d_atras * 100) if preco_30d_atras != 0 else 0

                    cluster_data["ativos"][ticker] = {
                        "preco": round(preco_atual, 2),
                        "volume": int(volume),
                        "variacao_30d_pct": round(variacao_30d, 2),
                        "papel": ativo_info["papel"],
                        "proxy": ativo_info["proxy"],
                        "timestamp": datetime.now().isoformat(),
                    }

                    if verbose:
                        print(f"  ‚úì {ticker}: ${preco_atual:.2f} ({variacao_30d:+.2f}%)")
                else:
                    if verbose:
                        print(f"  ‚ö† {ticker}: Sem dados")

            except Exception as e:
                if verbose:
                    print(f"  ‚úó {ticker}: Erro")

        all_data[cluster_id] = cluster_data

    return all_data

print("‚úì Fun√ß√£o de coleta de dados criada!")

"""üîÑ C√©lula 4: Buscar Dados (Executar Isto!)"""

print("‚è≥ Buscando dados de mercado... (pode levar 1-2 minutos)")
cluster_data = fetch_market_data(verbose=True)
print("\n‚úì Dados coletados com sucesso!")

"""üìà C√©lula 5: Gr√°fico 1 - Performance dos Clusters"""

# Preparar dados
cluster_performance = []

for cluster_id, cluster_info in cluster_data.items():
    variacao_media = sum([a["variacao_30d_pct"] for a in cluster_info["ativos"].values()]) / len(cluster_info["ativos"]) if cluster_info["ativos"] else 0
    cluster_performance.append({
        "Cluster": cluster_info["nome"][:25],
        "Varia√ß√£o M√©dia %": variacao_media
    })

df_performance = pd.DataFrame(cluster_performance)

# Criar gr√°fico
fig = px.bar(df_performance, x="Cluster", y="Varia√ß√£o M√©dia %",
             color="Varia√ß√£o M√©dia %",
             color_continuous_scale="RdYlGn",
             title="üìä Performance M√©dia dos Clusters (30 dias)",
             height=500)

fig.update_layout(xaxis_tickangle=-45, template="plotly_white")
fig.show()

"""üî• C√©lula 6: Gr√°fico 2 - Heatmap de Performance"""

# Preparar dados para heatmap
heatmap_data = []

for cluster_id, cluster_info in cluster_data.items():
    for ticker, ativo_data in cluster_info["ativos"].items():
        heatmap_data.append({
            "Cluster": cluster_info["nome"][:20],
            "Ticker": ticker,
            "Varia√ß√£o %": ativo_data["variacao_30d_pct"]
        })

df_heatmap = pd.DataFrame(heatmap_data)
pivot_df = df_heatmap.pivot_table(values="Varia√ß√£o %", index="Ticker", columns="Cluster", fill_value=0)

# Criar heatmap
fig = go.Figure(data=go.Heatmap(
    z=pivot_df.values,
    x=pivot_df.columns,
    y=pivot_df.index,
    colorscale="RdYlGn",
    zmid=0,
    colorbar=dict(title="Varia√ß√£o %")
))

fig.update_layout(
    title="üî• Heatmap de Performance - Todos os Clusters",
    height=600,
    template="plotly_white"
)

fig.show()

"""üìã C√©lula 7: Tabela de Resumo"""

# Criar tabela de resumo
summary_data = []

for cluster_id, cluster_info in cluster_data.items():
    variacao_media = sum([a["variacao_30d_pct"] for a in cluster_info["ativos"].values()]) / len(cluster_info["ativos"]) if cluster_info["ativos"] else 0

    summary_data.append({
        "Cluster": cluster_info["nome"],
        "Ativos": len(cluster_info["ativos"]),
        "Varia√ß√£o M√©dia (%)": f"{variacao_media:+.2f}%",
        "Driver": cluster_info["driver_principal"][:50]
    })

df_summary = pd.DataFrame(summary_data)

# Exibir como tabela
print("\n" + "="*120)
print("üìã RESUMO DE TODOS OS CLUSTERS")
print("="*120)
print(df_summary.to_string(index=False))
print("="*120)

"""üîç C√©lula 8: Detalhes de um Cluster Espec√≠fico"""

# Selecionar um cluster para an√°lise detalhada
cluster_id = "1_ia_infraestrutura"  # Mude este ID para ver outro cluster
cluster = cluster_data[cluster_id]

print(f"\nüìå {cluster['nome']}")
print(f"Tese: {cluster['tese']}")
print(f"Driver: {cluster['driver_principal']}")
print(f"Proxy: {cluster['proxy_narrativa']}\n")

# Criar tabela de ativos
ativos_list = []
for ticker, ativo_data in cluster["ativos"].items():
    ativos_list.append({
        "Ticker": ticker,
        "Pre√ßo": f"${ativo_data['preco']:.2f}",
        "Varia√ß√£o 30d (%)": f"{ativo_data['variacao_30d_pct']:+.2f}%",
        "Papel": ativo_data["papel"],
        "Proxy": ativo_data["proxy"],
    })

df_ativos = pd.DataFrame(ativos_list)
print(df_ativos.to_string(index=False))

# Gr√°fico de varia√ß√£o
chart_data = []
for ticker, ativo_data in cluster["ativos"].items():
    chart_data.append({
        "Ticker": ticker,
        "Varia√ß√£o %": ativo_data["variacao_30d_pct"]
    })

df_chart = pd.DataFrame(chart_data)
fig = px.bar(df_chart, x="Ticker", y="Varia√ß√£o %",
             color="Varia√ß√£o %",
             color_continuous_scale="RdYlGn",
             title=f"üìà {cluster['nome']} - Varia√ß√£o de Pre√ßo (30 dias)",
             height=400)

fig.update_layout(template="plotly_white")
fig.show()

"""üíæ C√©lula 9: Exportar Dados para CSV"""

# Exportar dados para CSV
df_summary.to_csv("cluster_summary.csv", index=False)
print("‚úì Dados exportados para 'cluster_summary.csv'")

# Exportar dados completos em JSON
import json
with open("cluster_data.json", "w") as f:
    json.dump(cluster_data, f, indent=2)
print("‚úì Dados completos exportados para 'cluster_data.json'")

# Voc√™ pode fazer download desses arquivos do Colab

"""üîÑ C√©lula 10: Atualizar Dados (Executar Periodicamente)"""

# Para atualizar os dados a qualquer momento, execute:
print("‚è≥ Atualizando dados...")
cluster_data = fetch_market_data(verbose=False)
print("‚úì Dados atualizados!")

# Depois execute novamente as c√©lulas de gr√°ficos para ver os dados atualizados